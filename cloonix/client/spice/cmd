#!/bin/bash
set -e
HERE=`pwd`
CLOONIX_COMMON=${HERE}/../../../cloonix/common
TARGZ=${HERE}/../../../targz_store
MESON_NINJA=${CLOONIX_COMMON}/meson_ninja
TARGET=${HERE}

if [ ! -f ${MESON_NINJA}/ninja/ninja ]; then
  cd ${MESON_NINJA}
  ./cmd
  cd ${HERE}
fi

cd ${HERE}/spice_client
./patched_create

cp -vf tainted_spice/subprojects/keycodemapdb/tools/keymap-gen tainted_spice 
cp -vf tainted_spice/subprojects/keycodemapdb/data/keymaps.csv tainted_spice


export DESTDIR=${TARGET}
export PATH=${TARGET}/bin:${MESON_NINJA}/ninja:${MESON_NINJA}/meson:$PATH

cd ${HERE}/spice_client/tainted_spice

sed -i s/UNKNOWN/0.39/ ./build-aux/git-version-gen

meson.py build
cd build
ninja install

cp -rf ${TARGET}/usr/local/* ${TARGET}
rm -rf ${TARGET}/usr/local
mkdir -p ${TARGET}/lib/pkgconfig
if [ -d ${TARGET}/lib/x86_64-linux-gnu/pkgconfig ]; then
  mv ${TARGET}/lib/x86_64-linux-gnu/pkgconfig/* ${TARGET}/lib/pkgconfig
  rmdir ${TARGET}/lib/x86_64-linux-gnu/pkgconfig
  mv ${TARGET}/lib/x86_64-linux-gnu/* ${TARGET}/lib
  rmdir ${TARGET}/lib/x86_64-linux-gnu
else
  if [ -d ${TARGET}/lib64/pkgconfig ]; then
    mv ${TARGET}/lib64/pkgconfig/* ${TARGET}/lib/pkgconfig
    rmdir ${TARGET}/lib64/pkgconfig
    mv ${TARGET}/lib64/* ${TARGET}/lib
    rmdir ${TARGET}/lib64
  else
    echo ERROR NO:
    echo ${TARGET}/lib/x86_64-linux-gnu/pkgconfig
    echo ${TARGET}/lib64/pkgconfig
    exit 1
  fi
fi




